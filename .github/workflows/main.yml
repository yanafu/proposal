# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®åå‰
name: AXEL-Orchestrator-Workflow

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒèµ·å‹•ã™ã‚‹ã€Œãã£ã‹ã‘ã€
on:
  issues:
    types: [labeled] # Issueã«ãƒ©ãƒ™ãƒ«ãŒè²¼ã‚‰ã‚ŒãŸã¨ã

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ä¸ãˆã‚‹ã€Œæ¨©é™ã€
permissions:
  contents: write       # ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒŸãƒƒãƒˆã«å¿…è¦
  pull-requests: write  # Pull Requestã®ä½œæˆã«å¿…è¦
  issues: write         # Issueã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¿…è¦

# å®Ÿè¡Œã•ã‚Œã‚‹ã€Œä»•äº‹ã€ã®å®šç¾©
jobs:
  # ã‚¸ãƒ§ãƒ–ã®åå‰
  agent-dispatcher:
    # å®Ÿè¡Œã™ã‚‹ä»®æƒ³ãƒã‚·ãƒ³ã®ç¨®é¡
    runs-on: ubuntu-latest
    # ã“ã®ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€Œæ¡ä»¶ã€
    if: github.event.label.name == 'initiate-proposal'
    # å…·ä½“çš„ãªã€Œæ‰‹é †ã€
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œæ¥­ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
      - name: Checkout repository
        uses: actions/checkout@v4

      # ã‚¹ãƒ†ãƒƒãƒ—2: Pythonã®å®Ÿè¡Œç’°å¢ƒã‚’æ•´ãˆã‚‹
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ã‚¹ãƒ†ãƒƒãƒ—3: å¿…è¦ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
      - name: Install dependencies
        run: pip install openai

      # ã‚¹ãƒ†ãƒƒãƒ—4: Logosã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰ã‚’å®Ÿè¡Œã™ã‚‹
      - name: Run Logos Agent
        id: logos_step # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã«IDã‚’ä»˜ã‘ã¦ã€å¾Œã§å‡ºåŠ›ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        run: python src/logos_agent.py
        env:
          # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æ¸¡ã™ç’°å¢ƒå¤‰æ•°
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          INPUT_TRIGGERING_LABEL: ${{ github.event.label.name }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}

      # ã‚¹ãƒ†ãƒƒãƒ—5: Logosã®æˆæœç‰©ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœãƒ¼ãƒ‰ï¼‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã™
      - name: Write agent outputs to file
        # logos_stepãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.logos_step.outputs.agent_outputs
        run: |
          # æ¡ˆä»¶ã”ã¨ã®ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆä¾‹: projects/1ï¼‰ãŒãªã‘ã‚Œã°ä½œæˆ
          mkdir -p projects/${{ github.event.issue.number }}
          # Pythonã‹ã‚‰ã®JSONå‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€status_file_contentã®å†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
          echo '${{ fromJson(steps.logos_step.outputs.agent_outputs).status_file_content }}' > projects/${{ github.event.issue.number }}/project_status.md
        shell: bash

      # ã‚¹ãƒ†ãƒƒãƒ—6: æ›¸ãå‡ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€Pull Requestã‚’ä½œæˆã™ã‚‹
      - name: Create Project Status Pull Request
        # logos_stepãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.logos_step.outputs.agent_outputs
        id: create_pr # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã«IDã‚’ä»˜ã‘ã¦ã€å¾Œã§PRç•ªå·ãªã©ã‚’å‚ç…§ã™ã‚‹
        uses: peter-evans/create-pull-request@v6
        with:
          # GitHub ActionsãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
          token: ${{ secrets.GITHUB_TOKEN }}
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆPythonã‹ã‚‰ã®å‡ºåŠ›ã‚’ä½¿ã†ï¼‰
          commit-message: ${{ fromJson(steps.logos_step.outputs.agent_outputs).pr_title }}
          # PRã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆPythonã‹ã‚‰ã®å‡ºåŠ›ã‚’ä½¿ã†ï¼‰
          title: ${{ fromJson(steps.logos_step.outputs.agent_outputs).pr_title }}
          # PRã®æœ¬æ–‡ï¼ˆPythonã‹ã‚‰ã®å‡ºåŠ›ã‚’ä½¿ã†ï¼‰
          body: ${{ fromJson(steps.logos_step.outputs.agent_outputs).pr_body }}
          # PRã®ãƒ–ãƒ©ãƒ³ãƒåï¼ˆæ¡ˆä»¶ã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹ï¼‰
          branch: feature/project-${{ github.event.issue.number }}
          # PRã®ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒ
          base: main
          # PRã«ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“è€…ã‚’å‰²ã‚Šå½“ã¦ã‚‹ï¼ˆIssueã‚’ä½œæˆã—ãŸäººï¼‰
          reviewers: ${{ github.actor }}
          # ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã«å«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
          add-paths: projects/${{ github.event.issue.number }}/project_status.md

      # ã‚¹ãƒ†ãƒƒãƒ—7: å…ƒã®Issueã«ã€Œå ±å‘Šã‚³ãƒ¡ãƒ³ãƒˆã€ã‚’æŠ•ç¨¿ã™ã‚‹
      - name: Post PR link to Issue
        # PRä½œæˆã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ã€PRç•ªå·ãŒå–å¾—ã§ããŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.create_pr.outputs.pull-request-number
        uses: peter-evans/create-or-update-comment@v4
        with:
          # ã©ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã‹
          issue-number: ${{ github.event.issue.number }}
          # ã‚³ãƒ¡ãƒ³ãƒˆã®å†…å®¹
          body: |
            ğŸ¤– **å¸ä»¤å¡” Logosã‚ˆã‚Šï¼š**

            @${{ github.actor }}
            åˆæœŸè¨­è¨ˆãŒå®Œäº†ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã®ãŸã‚ã®Pull Requestã‚’ä½œæˆã—ã¾ã—ãŸã€‚

            å†…å®¹ã‚’ã”ç¢ºèªã®ä¸Šã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            ğŸ‘‰ **[Pull Request #${{ steps.create_pr.outputs.pull-request-number }}](${{ steps.create_pr.outputs.pull-request-url }})**